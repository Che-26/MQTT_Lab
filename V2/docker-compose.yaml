version: '3.8'

services:
  vault:
    image: vault:1.13.3
    container_name: vault-server
    restart: unless-stopped
    ports:
      - "2290:8200"  # Через роутер порт 2290
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=root-token-${VAULT_SECRET}
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_ADDR=http://0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    volumes:
      - vault_data:/vault/file
      - ./vault/config:/vault/config
      - ./vault/scripts:/vault/scripts
    command: server -dev -dev-root-token-id=root-token-${VAULT_SECRET}

  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mqtt-broker
    restart: unless-stopped
    ports:
      - "2291:1883"  # MQTT без TLS через роутер
      - "2292:8883"  # MQTT с TLS через роутер
      - "9001:9001"  # WebSocket для внутреннего веб-сервера
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
      - ./certs:/mosquitto/certs
    depends_on:
      vault:
        condition: service_started
#    command: mosquitto_passwd -c passwordfile scheusov ~1qaz~1qaz | mosquitto_passwd -U passwordfile

volumes:
  vault_data: