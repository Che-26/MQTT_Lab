version: '3.8'

services:
  # HashiCorp Vault с внешними портами через роутер
  vault:
    image: vault:1.13.3
    container_name: vault-server
    restart: unless-stopped
    ports:
      - "2290:8200"  # Порт на роутере 2290 → внутренний 8200
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=root-token-${VAULT_SECRET:-default-secret}
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_ADDR=http://0.0.0.0:8200
      - VAULT_API_ADDR=http://0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    volumes:
      - vault_data:/vault/file
      - ./vault/config:/vault/config
      - ./vault/scripts:/vault/scripts
    command: server -dev -dev-root-token-id=root-token-${VAULT_SECRET:-default-secret} -config=/vault/config/vault.hcl

  # Mosquitto MQTT брокер с внешними портами
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mqtt-broker
    restart: unless-stopped
    ports:
      - "2291:1883"  # MQTT без TLS через роутер
      - "2292:8883"  # MQTT с TLS через роутер
      - "9001:9001"  # WebSocket (внутренний для веб-сервера)
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
      - ./certs:/mosquitto/certs
    depends_on:
      - vault
    environment:
      - MQTT_EXTERNAL_IP=${MQTT_EXTERNAL_IP}
      - MQTT_EXTERNAL_PORT_TLS=2292
      - MQTT_EXTERNAL_PORT=2291
    networks:
      - mqtt-network

volumes:
  vault_data:

networks:
  mqtt-network:
    driver: bridge